<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />

    <title>Server stats</title>

    <style>
      table,
      td {
        border: 1px solid #333;
      }

      thead {
        background-color: #333;
        color: #fff;
      }
    </style>
  </head>

  <body>
    <main>
      <h1>chat</h1>

      <ul class="users-list"></ul>
    </main>

    <script>
      (function () {
        const id = crypto.randomUUID();

        const usersList = document.querySelector(".users-list");

        const rss = document.getElementById("rss");
        const heapTotal = document.getElementById("heapTotal");
        const heapUsed = document.getElementById("heapUsed");
        const external = document.getElementById("external");
        const ws = new WebSocket(`ws://${location.host}`);

        ws.addEventListener("open", () => {
          console.log("open");

          ws.send(
            JSON.stringify({
              type: "add-user",
              payload: {
                id,
              },
            })
          );
        });

        ws.addEventListener("message", (event) => {
          // event.data
          // event.origin
          // event.lastEventId
          // event.source
          // event.ports

          const data = JSON.parse(event.data);
          console.log("ðŸš€ ~ data", data);

          if (data.type === "update-users") {
            usersList.innerHTML = data.payload.users.reduce((acc, cur) => {
              return `${acc}<li>${cur}</li>`;
            }, "");

            return;
          }
        });

        ws.addEventListener("error", (event) => {
          console.error("websocket error", { event });
        });

        ws.addEventListener("close", (event) => {
          // event.close
          // event.reason
          // event.wasClean

          console.debug("websocket close", { event });
        });
      })();
    </script>
  </body>
</html>
